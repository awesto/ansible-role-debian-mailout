- name: exmi4 installed
  apt:
      pkg=exim4

- name: passwd.client file installed
  template:
    src: passwd.client.j2
    dest: /etc/exim4/passwd.client
    owner: root
    group: Debian-exim
    mode: 0640
  notify: reload exim4

- name: "exim4 configuration: smarthost"
  debconf:
      name: exim4-config
      question: exim4/dc_smarthost
      value: "{{ debian_mailout_smarthost_hostname }}::{{ debian_mailout_smarthost_port }}"
      vtype: string
  notify: reload exim4

- name: "exim4 configuration: mailname"
  debconf:
      name: exim4-config
      question: exim4/mailname
      value: "{{ inventory_hostname }}"
      vtype: string
  notify: reload exim4

- name: "exim4 configuration: configtype"
  debconf:
      name: exim4-config
      question: exim4/configtype
      value: mail sent by smarthost; no local mail
      vtype: string
  notify: reload exim4

- name: "exim4 configuration: local interfaces"
  debconf:
      name: exim4-config
      question: exim4/dc_local_interfaces
      value: "127.0.0.1 ; ::1"
      vtype: string
  notify: reload exim4

- name: "Patch update-exim4.conf.conf (configtype)"
  lineinfile:
    dest: /etc/exim4/update-exim4.conf.conf
    line: "dc_eximconfig_configtype='smarthost'"
    regexp: "^dc_eximconfig_configtype="

- name: "Patch update-exim4.conf.conf (hostname)"
  lineinfile:
    dest: /etc/exim4/update-exim4.conf.conf
    line: "dc_other_hostnames='{{ inventory_hostname }}'"
    regexp: "^dc_other_hostnames="

- name: "Patch update-exim4.conf.conf (smarthost)"
  lineinfile:
    dest: /etc/exim4/update-exim4.conf.conf
    line: "dc_smarthost='{{ debian_mailout_smarthost_hostname }}'"
    regexp: "^dc_smarthost="

- name: update-exim4.conf
  command: update-exim4.conf

- name: exim4 Catchall recipient
  blockinfile:
    dest: /etc/exim4/exim4.conf.template
    block: |
      catchall_pub:
        driver = redirect
        domains = {{ inventory_hostname }}
        data = {{ debian_mailout_catchall_recipient }}
    insertafter: "^begin routers$"

- name: reload exim4
  service:
    name: exim4
    state: reloaded
